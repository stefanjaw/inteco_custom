<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template  id="registration_template_inherit" inherit_id="website_event.registration_template" >
        <xpath expr="//form[1]" position="replace">
            <form t-if="event.event_registrations_open and (not event.event_ticket_ids or any(not ticket.is_expired for ticket in event.event_ticket_ids))"
                  id="registration_form2"
                  class="mb-5"
                  t-attf-action="/event/registration/new_attendees" method="post"
                  itemscope="itemscope" itemprop="offers" itemtype="http://schema.org/AggregateOffer">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <input type="hidden" name="event" t-att-value="event.id"/>
                <div id="o_wevent_tickets" class="bg-white shadow-sm o_wevent_js_ticket_details" data-folded-by-default="0">
                    <t t-set="tickets" t-value="event.event_ticket_ids.filtered(lambda ticket: not ticket.is_expired)"/>
                    <!-- If some tickets expired and there is only one type left, we keep the same layout -->
                    <t t-if="len(event.event_ticket_ids) &gt; 1">
                        <div class="d-flex justify-content-between align-items-center py-2 pl-3 pr-2 border-bottom">
                            <div id="price-range" class="pr-3 d-none"/>
                            <span t-if="not event.event_registrations_open" class="text-danger">
                                <i class="fa fa-ban mr-2"/>Sold Out
                            </span>
                            <div t-if="event.is_participating" id="registered" class="ml-auto pr-3 d-none">
                                <span class="o_wevent_badge badge badge-success ml-3">
                                    <i class="fa fa-check mr-2"/>Registered
                                </span>
                            </div>
                            <a href="#" role="button" class="btn o_wevent_registration_btn text-left" data-target="#o_wevent_tickets_collapse">
                                <span class="py-2">Tickets</span>
                                <span class="close d-none">×</span>
                            </a>
                        </div>
                        <div id="o_wevent_tickets_collapse" class="collapse show">
                            <div t-foreach="tickets" t-as="ticket" class="row px-3 py-3 mx-0 bg-light border-bottom">
                                <div class="col-md-8 col-xs-12 p-0" itemscope="itemscope" itemtype="http://schema.org/Offer">
                                    <h5 itemprop="name" t-field="ticket.name" class="my-0"/>
                                    <t t-if="ticket.description">
                                        <small t-field="ticket.description" class="text-muted py-2"/>
                                        <br/>
                                    </t>
                                    <small t-if="ticket.end_sale_date and ticket.sale_available and not ticket.is_expired" class="text-muted mr-3" itemprop="availabilityEnds">Sales end on <span itemprop="priceValidUntil" t-field="ticket.end_sale_date"/></small>
                                    <small t-if="ticket.start_sale_date and not ticket.sale_available and not ticket.is_expired" class="text-muted mr-3" itemprop="availabilityEnds">Sales start on <span itemprop="priceValidUntil" t-field="ticket.start_sale_date"/></small>
                                </div>
                                <div class="col-md-4 col-xs-12 p-0 d-flex align-items-center justify-content-between">
                                    <div class="o_wevent_registration_multi_select"/>
                                    <div class="w-auto ml-auto">
                                        <select t-if="not ticket.is_expired and ticket.sale_available"
                                                t-attf-name="nb_register-#{ticket.id}"
                                                class="custom-select">
                                            <t t-set="seats_max_ticket" t-value="(not ticket.seats_limited or ticket.seats_available &gt; 9) and 10 or ticket.seats_available + 1"/>
                                            <t t-set="seats_max_event" t-value="(not event.seats_limited or event.seats_available &gt; 9) and 10 or event.seats_available + 1"/>
                                            <t t-set="seats_max" t-value="min(seats_max_ticket, seats_max_event)"/>
                                            <t t-foreach="range(0, seats_max)" t-as="nb">
                                                <option t-esc="nb" t-att-selected="len(ticket) == 0 and nb == 0 and 'selected'"/>
                                            </t>
                                        </select>
                                        <div t-else="" class="text-danger">
                                            <span t-if="not ticket.sale_available and not ticket.is_expired and ticket.is_launched()" >Sold Out</span>
                                            <span t-if="ticket.is_expired">Expired</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row no-gutters">
                                <div class="col-md-4 offset-md-8 py-2 pl-md-0 pr-md-2">
                                    <button type="submit" class="btn btn-primary o_wait_lazy_js btn-block a-submit" disabled="" t-attf-id="#{event.id}">
                                        Registro
                                        <t t-if="event.seats_limited and event.seats_max and event.seats_available &lt;= (event.seats_max * 0.2)">
                                            (only <t t-esc="event.seats_available"/> available)
                                        </t>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </t>
                    <div t-else="" class="o_wevent_registration_single">
                        <div class="row p-2 pl-3">
                            <div class="col-lg-8 d-flex flex-columns align-items-center" itemscope="itemscope" itemtype="http://schema.org/Offer">
                                <h6 itemprop="name" class="my-0 pr-3 border-right text-dark">
                                    <span t-if="tickets" t-field="tickets.name"/>
                                    <span t-else="">Registration</span>
                                </h6>
                                <div class="ml-auto o_wevent_nowrap">
                                    <t t-if="event.event_registrations_open">
                                        <span class="text-dark font-weight-bold align-middle pr-2">Qty</span>
                                        <link itemprop="availability" content="http://schema.org/InStock"/>
                                        <select t-att-name="'nb_register-%s' % (tickets.id if tickets else 0)" class="w-auto custom-select">
                                            <t t-set="seats_max_ticket" t-value="(not tickets or not tickets.seats_limited or tickets.seats_available &gt; 9) and 10 or tickets.seats_available + 1"/>
                                            <t t-set="seats_max_event" t-value="(not event.seats_limited or event.seats_available &gt; 9) and 10 or event.seats_available + 1"/>
                                            <t t-set="seats_max" t-value="min(seats_max_ticket, seats_max_event) if tickets else seats_max_event"/>
                                            <t t-foreach="range(0, seats_max)" t-as="nb">
                                                <option t-esc="nb" t-att-selected="nb == 1 and 'selected'"/>
                                            </t>
                                        </select>
                                    </t>
                                    <t t-else="">
                                        <span itemprop="availability" content="http://schema.org/SoldOut" class="text-danger">
                                            <i class="fa fa-ban mr-2"/>Sold Out
                                        </span>
                                    </t>
                                </div>
                            </div>
                            <div class="col-lg-4 pt-3 pt-lg-0 pl-2 pl-lg-0">
                                <button type="submit" class="btn btn-primary o_wait_lazy_js btn-block a-submit" t-attf-id="#{event.id}">
                                    Registro
                                    <t t-if="event.seats_limited and event.seats_max and event.seats_available &lt;= (event.seats_max * 0.2)">
                                        (only <t t-esc="event.seats_available"/> available)
                                    </t>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </xpath>
    </template>

    <template id="dfx_registration_attendee_template" >
        <t t-call="website.layout">
            <div class="container">
                <form id="attendee_registration" t-attf-action="/event/#{slug(event)}/registration/confirm" method="post" class="js_website_submit_form">
                    <input type="hidden" id="route" name="route" t-att-value="route"/>
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <input type="hidden" name="event" t-att-value="event"/>
                    <div class="text-center pt16">
                        <h2 t-esc="event.name"/>
                        <h4 class="modal-title">Registro de asistentes</h4>
                    </div>
                    <t t-set="counter_type" t-value="1"/>
                    <t t-set="counter" t-value="0"/>
                    <t t-foreach="tickets" t-as="ticket">
                        <t t-if="ticket['quantity'] &gt; 1">
                            <div class="alert alert-danger m-0 mt16" role="alert" style="color: white;background-color: red;border-color: red;font-size: 1.3rem;font-weight: 500;">
                                <h4 class="alert-heading">¡Atención!</h4>
                                <p>Si requiere <strong>una factura por cada</strong> participante, debe realizar los registros <strong>uno a uno</strong> de los participantes a inscribir. En caso contrario y de continuar con este formulario, se le realizará <strong>una única factura</strong> por los participantes inscritos</p>
                            </div>
                        </t>
                        <t t-else="">

                        </t>
                    </t>
                    <div class="modal-body">
                        <t t-foreach="tickets" t-as="ticket" t-if="availability_check">
                            <h4 class="o_page_header mt16">
                                <strong>
                                    Ticket Type #<t t-raw="counter_type"/>: <span style="color:#f5a623;"><t t-esc="ticket['name']"/></span>
                                    <!--                            <t t-if="ticket['price'] == 0">(Gratuito)</t>-->
                                </strong>
                            </h4>
                            <t t-foreach="range(1, ticket['quantity'] + 1)" t-as="att_counter" name="attendee_loop">
                                <t t-set="counter" t-value="counter + 1"/>
                                <div class="col-lg-4 px-0 pb8"><h4 style="font-weight:bolder; color:#00A0E3;">Asistente <t t-raw="counter"/></h4></div>
                                <div class="row mb12">
                                    <t t-set="attendee_placeholder">Asistente #%s</t>
                                    <div class="col-lg-3 pb8"><input class="form-control" type="text" t-attf-name="#{counter}-name" required="Este campo es requerido" placeholder="Nombre (*)"/></div>
                                    <div class="col-lg-3 pb8"><input class="form-control" type="text" t-attf-name="#{counter}-firstname" required="Este campo es requerido" placeholder="Apellido 1 (*)"/></div>
                                    <div class="col-lg-3 pb8"><input class="form-control" type="text" t-attf-name="#{counter}-lastname" placeholder="Apellido 2"/></div>
                                    <div class="col-lg-3 pb8"><input class="form-control" type="email" t-attf-name="#{counter}-email" required="Este campo es requerido" placeholder="Correo Electrónico (*)"/></div>
                                    <!--                                <div class="col-lg-3 pb8"><input class='form-control' value="1" type='text' t-attf-name="#{counter}-types_identification" required="This field is required" placeholder="Tipo de Identificación"/></div>-->
                                    <div class="col-lg-3 pb8">
                                        <select id="type_id_list" t-attf-name="#{counter}-types_identification" class="form-control o_website_form_input needsclick custom-select" required="True">
                                            <option value="1">
                                                Cédula Física
                                            </option>
                                            <option value="3">
                                                DIMEX
                                            </option>
                                            <option value="4">
                                                NITE
                                            </option>
                                            <option value="5">
                                                Extranjero
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-lg-3 pb8"><input class="form-control" type="text" t-attf-name="#{counter}-idatt" required="Este campo es requerido" placeholder="Identificación (*)"/></div>
                                    <div class="col-lg-3 pb8"><input class="form-control" type="tel" t-attf-name="#{counter}-phone" placeholder="Teléfono"/></div>
                                    <div class="col-lg-3 pb8"><input class="form-control" type="text" t-attf-name="#{counter}-position" required="Este campo es requerido" placeholder="Puesto (*)"/></div>
                                    <input class="d-none" type="text" t-attf-name="#{counter}-ticket_id" t-attf-value="#{ticket['id']}"/>
                                </div>

                                <div class="row pt16 pb12">
                                    <div class="col-lg-12 pb8"><strong>Seleccione otros temas de su interés para recibir información:</strong></div>
                                    <div class="col-lg-4 pb8" t-foreach="event.env['res.partner.category'].search([('is_interest_topic', '=', True)])" t-as="category">
                                        <t t-if="category.id in event.interest_topics.ids">
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" t-attf-id="id_#{category.id}" t-attf-name="#{counter}-tag_ids#{category.id}" checked="checked" disabled="disabled"/>
                                                    <span style="font-weight:500" t-esc="category.name+' '"/>
                                                </label>
                                            </div>
                                        </t>
                                        <t t-else="">
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" t-attf-id="id_#{category.id}" t-attf-name="#{counter}-tag_ids#{category.id}"/>
                                                    <span style="font-weight:500" t-esc="category.name+' '"/>
                                                </label>
                                            </div>
                                        </t>
                                    </div>
                                </div>

                                <t t-if="event.specific_question_ids">
                                    <div class="mb16 mt16">
                                        <div class="col-lg-12 pb8 p-0"><strong>Por favor responda las siguientes preguntas:</strong></div>
                                        <t t-set="counter_id" t-value="0"/>
                                        <div t-foreach="event.specific_question_ids" t-as="question" id="questions_select">
                                            <div class="row mb4 question_title" id="group_questions">
                                                <span class="col-lg-12 col-sm-6 mt4"><t t-esc="question.title"/></span>
                                                <t t-if="question.question_type == 'simple_choice'">
                                                    <div id="select_container" class="col-lg-12 col-sm-6">
                                                        <select t-attf-name="#{counter}-answer_ids-#{question.id}" t-attf-id="answer_select_#{counter_id}" class="col-lg-4 mt4 custom-select o_specific_answer" required="true">
                                                            <t t-foreach="question.answer_ids" t-as="answer">
                                                                <option t-esc="answer.name" t-att-value="answer.id" t-att-data-value="answer.valid_event_anw"/>
                                                            </t>

                                                        </select>
                                                        <t t-set="counter_id" t-value="counter_id + 1"/>
                                                        <div t-attf-id="wrong_amswer__#{counter_id}" class="col-lg-6 ml-2 mt-1 py-1 d-none" role="alert">
                                                            *La opción seleccionada es incorrecta
                                                        </div>
                                                    </div>
                                                </t>
                                                <t t-else="">
                                                    <div class="col-lg-12 col-sm-6">
                                                        <textarea t-attf-name="#{counter}-answer_ids-#{question.id}" class="col-lg-12 form-control"/>
                                                    </div>
                                                    <t t-set="counter_id" t-value="counter_id + 1"/>
                                                </t>
                                            </div>
                                        </div>
                                    </div>
                                </t>

                            </t>
                            <t t-set="counter_type" t-value="counter_type + 1"/>
                        </t>
                        <t t-if="not availability_check">
                            <div class="modal-body bg-light border-bottom">
                                <strong> You ordered more tickets than available seats</strong>
                            </div>
                        </t>
                    </div>
                    <div class="modal-footer border-0 justify-content-between">
                        <button id="back_register" type="button" class="btn btn-secondary js_goto_event">Volver</button>
                        <button id="event_continue" type="submit" class="btn btn-primary" t-if="availability_check">Continuar</button>
                    </div>
                </form>
            </div>
        </t>

    </template>

    <template id="registration_template" inherit_id="dfx_inteco_events.registration_template_inherit">
        <!-- Add price information on tickets (multi tickets, aka in collapse) -->
        <xpath expr="//div[hasclass('o_wevent_registration_multi_select')]" position="inside">
            <t t-if="ticket.price">
                <t t-if="(ticket.price-website.get_current_pricelist().currency_id._convert(ticket.price_reduce, event.company_id.sudo().currency_id, event.company_id, datetime.date.today())) &gt; 1 and website.get_current_pricelist().discount_policy == 'without_discount'">
                    <del class="text-danger mr-1" t-field="ticket.price" t-options="{'widget': 'monetary', 'from_currency': event.company_id.sudo().currency_id, 'display_currency': website.get_current_pricelist().currency_id}"/>
                </t>
                <span t-field="ticket.price_reduce" t-options="{'widget': 'monetary', 'display_currency': website.pricelist_id.currency_id}" groups="account.group_show_line_subtotals_tax_excluded"/>
                <span t-field="ticket.price_reduce_taxinc" t-options="{'widget': 'monetary', 'display_currency': website.pricelist_id.currency_id}" groups="account.group_show_line_subtotals_tax_included"/>
                <span itemprop="price" class="d-none" t-esc="ticket.price"/>
                <span itemprop="priceCurrency" class="d-none" t-esc="website.pricelist_id.currency_id.name"/>
            </t>
            <span t-else="" class="font-weight-bold text-uppercase">Free</span>
        </xpath>
        <xpath expr="//div[@id='price-range']" position="inside">
            <span class="text-dark">
                From
                <span t-esc="event.event_ticket_ids[0].price_reduce" t-options="{'widget': 'monetary', 'display_currency': website.pricelist_id.currency_id}"/>
                to
                <span t-esc="event.event_ticket_ids[-1].price_reduce" t-options="{'widget': 'monetary', 'display_currency': website.pricelist_id.currency_id}"/>
            </span>
        </xpath>
        <!-- Add price information on tickets (mono ticket, aka not in collapse) -->
        <xpath expr="//div[hasclass('o_wevent_registration_single')]//h6" position="after">
            <div class="px-2 text-dark mr-2 border-right d-flex align-items-center align-self-stretch">
                <t t-if="tickets.price">
                    <t t-if="(tickets.price-website.get_current_pricelist().currency_id._convert(tickets.price_reduce, event.company_id.sudo().currency_id, event.company_id, datetime.date.today())) &gt; 1 and website.get_current_pricelist().discount_policy == 'without_discount'">
                        <del class="text-danger mr-1" t-field="tickets.price" t-options="{'widget': 'monetary', 'from_currency': event.company_id.sudo().currency_id, 'display_currency': website.get_current_pricelist().currency_id}"/>
                    </t>
                    <span t-field="tickets.price_reduce" t-options="{'widget': 'monetary', 'display_currency': website.pricelist_id.currency_id}" groups="account.group_show_line_subtotals_tax_excluded"/>
                    <span t-field="tickets.price_reduce_taxinc" t-options="{'widget': 'monetary', 'display_currency': website.pricelist_id.currency_id}" groups="account.group_show_line_subtotals_tax_included"/>
                    <span itemprop="price" class="d-none" t-esc="tickets.price"/>
                    <span itemprop="priceCurrency" class="d-none" t-esc="website.pricelist_id.currency_id.name"/>
                </t>
                <span t-else="" class="font-weight-bold text-uppercase">Free</span>
            </div>
        </xpath>
    </template>


    <record id="dfx_registration_attendee_page" model="website.page">
        <field name="url">/event/registration/new_attendees</field>
        <field name="is_published">True</field>
        <field name="view_id" ref="dfx_registration_attendee_template"/>
        <field name="track">True</field>
    </record>


</odoo>
